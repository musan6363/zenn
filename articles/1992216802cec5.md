---
title: "Singularityã§Pyenv&Poetryç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "Pyenv", "Poetry", "Singularity"]
published: true
---

# Singularityã§PoetryãŒä½¿ã„ãŸã„
ã“ã‚Œã¾ã§Singualrityä¸Šã®Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã¯pipã§è¡Œã£ã¦ã„ã¾ã—ãŸï¼  
æœ€è¿‘ï¼Œä»¥ä¸‹ã®è¨˜äº‹ã‚’ãã£ã‹ã‘ã«Poetryã®å­˜åœ¨ã‚’çŸ¥ã‚Šï¼Œèª¿ã¹ã¦ã„ãã†ã¡ã«è™œã«ãªã‚Šã¾ã—ãŸï¼  
[Pythonç’°å¢ƒæ§‹ç¯‰[Pyenv+Poetry]ï½œç ”ç©¶ã®ãŸã‚ã®Pythoné–‹ç™ºç’°å¢ƒ](https://zenn.dev/zenizeni/books/a64578f98450c2/viewer/c6af80)  

ä»Šå¾Œï¼Œé–‹ç™ºã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å…¬é–‹ã‚‚è¦‹æ®ãˆï¼Œç’°å¢ƒã®å†ç¾æ€§ã‚’æ‹…ä¿ã™ã‚‹ãŸã‚ã«ã‚‚Poetryã‚’å°å…¥ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼  

ã¾ãŸå‰¯æ¬¡çš„ãªç”£ç‰©ã¨ã—ã¦ï¼ŒSingularityã§pipã‚’ä½¿ã†å ´åˆï¼Œæ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ã¯defãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†è¨˜è¿°ã—ã¦buildã—ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒï¼ŒPoetryã§ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã‹ã‚‰æ–°ãŸãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ãŒå¯èƒ½ã§ã™ï¼ã‚‚ã¡ã‚ã‚“ï¼Œpyproject.tomlã«è¿½åŠ ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã‚‹ã®ã§ï¼Œå¾Œã®ç’°å¢ƒå†ç¾ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼  

# Definition File
å…ˆç¨‹ã®è¨˜äº‹ã«å¾“ã„ï¼ŒSingularityã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹Definition Fileã‚’ä»¥ä¸‹ã®é€šã‚Šè¨˜è¿°ã—ã¾ã—ãŸï¼  
```def:pyenvpoetry.def
Bootstrap: docker
From: nvidia/cuda:11.3.1-cudnn8-devel-ubuntu20.04

%environment
	export TZ=Asia/Tokyo
	export CUDA_PATH=/usr/local/cuda
	export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

	export PYENV_ROOT="/opt/pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"

	export POETRY_HOME=/opt/poetry
    export PATH=$POETRY_HOME/bin:$PATH
    
    # Pyenvã®Pythonã‚’åˆ©ç”¨
    export PATH=$PYENV_ROOT/shims:$PATH

%post
    perl -p -i.bak -e 's%(deb(?:-src|)\s+)https?://(?!archive\.canonical\.com|security\.ubuntu\.com)[^\s]+%$1http://ftp.riken.jp/Linux/ubuntu/%' /etc/apt/sources.list

	export DEBIAN_FRONTEND=noninteractive
	export TZ=Asia/Tokyo

	export PYENV_ROOT="/opt/pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"
	export PYTHON_VERSION=3.11
	export POETRY_ROOT="/opt/poetry"

	apt-get -y update
	apt-get -y dist-upgrade
    apt-get -y install \
		build-essential \
        curl \
        git \
        libbz2-dev \
        libffi-dev \
        libreadline-dev \
        libsqlite3-dev \
        libssl-dev \
        liblzma-dev \
        llvm \
        make \
        tk-dev \
        wget \
        xz-utils \
        zlib1g-dev

	# Install pyenv
    git clone https://github.com/pyenv/pyenv.git $PYENV_ROOT

	
	eval "$(pyenv init --path)"

	pyenv install $PYTHON_VERSION
	pyenv local $PYTHON_VERSION

	# Install poetry
	curl -sSL https://install.python-poetry.org | POETRY_HOME=$POETRY_ROOT python -

%labels
    Author msn
    Version v1.0.0
```
ä»Šå¾Œï¼ŒGPUã®æ´»ç”¨(PyTorchã®å°å…¥)ã‚’è¦–é‡ã«å…¥ã‚Œã¦ã„ã‚‹ãŸã‚ï¼Œãƒ™ãƒ¼ã‚¹ã«Dockerã§é…å¸ƒã•ã‚Œã¦ã„ã‚‹cudaã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒï¼Œã‚·ãƒ³ãƒ—ãƒ«ãªUbuntuç’°å¢ƒã§ã‚‚å•é¡Œãªã„ã¨æ€ã„ã¾ã™ï¼  

æ³¨æ„ç‚¹ã¨ã—ã¦ï¼ŒBuildæ™‚ã«`%post`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯`/root`ã¨ãªã‚Šï¼Œå„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã«å½±éŸ¿ã—ã¾ã™ï¼  
ãã“ã§ï¼Œä»Šå›ã¯`/opt`ä»¥ä¸‹ã«æ˜ç¤ºçš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ï¼ã¾ãŸï¼Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã¸ã®ãƒ‘ã‚¹é–‹é€šã‚’`%environment`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¡Œã„ï¼Œshellå®Ÿè¡Œæ™‚ã«åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼  

# æ¤œè¨¼
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§Buildã—ã¾ã—ãŸï¼  
ç§ã®ç’°å¢ƒã§ã¯ï¼Œ`--fakeroot`æ¨©é™ã®ã¿ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã§Buildã—ã¦ã„ã¾ã™ï¼  

```sh:build
singularity build --fakeroot pyenvpoetry.sif pyenvpoetry.def
```

Buildå®Œäº†å¾Œã«ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å…¥ã‚Šï¼Œãƒ‘ã‚¹ã®é–‹é€šã¨ï¼ŒPython, Poetryã®å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã—ãŸï¼  

ã‚¤ãƒ¡ãƒ¼ã‚¸åŒ–ã—ãŸå¾Œã§ã‚‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸï¼

Pyenvã«ã‚ˆã‚‹è¿½åŠ ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ï¼ŒPyenvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã§ã‚ã‚‹`/opt/pyenv`ãŒä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ã§æ›¸ãè¾¼ã¿ä¸èƒ½ãªãŸã‚ï¼Œå¤±æ•—ã—ã¾ã—ãŸï¼  
è¤‡æ•°ã®Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ï¼Œäºˆã‚defãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ï¼

```sh:check
which pyenv
# /opt/pyenv/bin/pyenv

which poetry
# /opt/poetry/bin/poetry

### poetryã®å‹•ä½œãƒã‚§ãƒƒã‚¯ ###
poetry init
# (å‡ºåŠ›çœç•¥)ã™ã¹ã¦returnã‚’æŠ¼ã—ã¦é€²ã‚ã‚‹

poetry shell
which python
# /{USERHOME}/.cache/pypoetry/virtualenvs/hoge-h8c379Fr-py3.11/bin/python

# ndjsonãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
python
# Python 3.11.2 (main, Mar 16 2023, 16:36:22) [GCC 9.4.0] on linux
# Type "help", "copyright", "credits" or "license" for more information.
>>> import ndjson
## Traceback (most recent call last):
##   File "<stdin>", line 1, in <module>
## ModuleNotFoundError: No module named 'ndjson'
>>> exit()

# ndjsonã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦è¿½åŠ ã‚’ç¢ºèª
poetry add ndjson
## Using version ^0.3.1 for ndjson
## 
## Updating dependencies
## Resolving dependencies... (0.1s)
## 
## Writing lock file
## 
## Package operations: 1 install, 0 updates, 0 removals
## 
##   â€¢ Installing ndjson (0.3.1)

python
# Python 3.11.2 (main, Mar 16 2023, 16:36:22) [GCC 9.4.0] on linux
# Type "help", "copyright", "credits" or "license" for more information.
>>> import ndjson
# ErrorãŒå‡ºãšæˆåŠŸ

exit  # poetry shellã‹ã‚‰ã®é€€å‡º

cd ../
mkdir foo
cd foo

### pyenvã®è¿½åŠ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« -> å¤±æ•— ###
pyenv install 3.9
# perl: warning: Setting locale failed.
# perl: warning: Please check that your locale settings:
#         LANGUAGE = (unset),
#         LC_ALL = (unset),
#         LC_TERMINAL = "iTerm2",
#         LANG = "en_US.UTF-8"
#     are supported and installed on your system.
# perl: warning: Falling back to the standard locale ("C").
# Downloading Python-3.9.16.tar.xz...
# -> https://www.python.org/ftp/python/3.9.16/Python-3.9.16.tar.xz
# Installing Python-3.9.16...
# 
# BUILD FAILED (Ubuntu 20.04 using python-build 2.3.15-1-g4ef81b5c)
# 
# Inspect or clean up the working tree at /tmp/python-build.20230317101532.1581633
# Results logged to /tmp/python-build.20230317101532.1581633.log
# 
# Last 10 log lines:
# changing mode of build/scripts-3.9/idle3 from 644 to 755
# changing mode of build/scripts-3.9/2to3 from 644 to 755
# renaming build/scripts-3.9/pydoc3 to build/scripts-3.9/pydoc3.9
# renaming build/scripts-3.9/idle3 to build/scripts-3.9/idle3.9
# renaming build/scripts-3.9/2to3 to build/scripts-3.9/2to3-3.9
# Creating directory /opt/pyenv/versions/3.9.16/bin
# /usr/bin/install: cannot create directory '/opt/pyenv/versions/3.9.16': Read-only file system
# Creating directory /opt/pyenv/versions/3.9.16/lib
# /usr/bin/install: cannot create directory '/opt/pyenv/versions/3.9.16': Read-only file system
# make: *** [Makefile:1313: altbininstall] Error 1
```

# ã‚€ã™ã³
Singularityã§Pyenvã¨Poetryã«ã‚ˆã‚‹Pythonç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã„ã¾ã—ãŸï¼  
Poetryã«ã‚ˆã£ã¦ç’°å¢ƒå†ç¾æ€§ãŒé«˜ãï¼ŒSingularityã®åˆ©ç‚¹ã®ä¸€ã¤ã§ã‚ã‚‹å†ç¾æ€§ã‚’ã‚ˆã‚Šé«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼  
ã¾ãŸå¾“æ¥ã®pipã§ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸åŒ–ã—ã¦ã‹ã‚‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ãŒä¸å¯èƒ½ã§ã—ãŸï¼ä¸€æ–¹ï¼ŒPoetryã®addã‚³ãƒãƒ³ãƒ‰ã¯Buildå¾Œã§ã‚‚è¿½åŠ ãŒã§ãã‚‹ã“ã¨ã‹ã‚‰ï¼Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¿½åŠ ã®ãŸã‚ã«defãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£ãƒ»å†BuildãŒä¸è¦ã ã¨ã‚ã‹ã‚Šï¼Œé–‹ç™ºã®åŠ¹ç‡åŒ–ãŒæœŸå¾…ã•ã‚Œã¾ã™ï¼  
ãŸã ã—ï¼ŒPyenvã«ã‚ˆã£ã¦è¤‡æ•°ã®Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’Buildå¾Œã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã§ã—ãŸï¼äºˆã‚defãƒ•ã‚¡ã‚¤ãƒ«ã§å¿…è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã‹ï¼ŒPyenvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã‚’ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãŒæ›¸è¾¼ã¿å¯èƒ½ãªé ˜åŸŸã‚’é¸æŠã™ã‚‹(Singularityã§ã¯ä¸å¯èƒ½ï¼Ÿ)å¿…è¦ãŒã‚ã‚Šï¼Œã•ã‚‰ãªã‚‹æ¤œè¨¼ãŒå¿…è¦ã§ã™ï¼

ä»Šå¾Œã¯ä»Šå›ã®ç’°å¢ƒã«PyTorchã®å°å…¥ã‚’è©¦ã¿ã¾ã™ï¼