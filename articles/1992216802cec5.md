---
title: "Singularityã§Pyenv&Poetryç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Python", "Pyenv", "Poetry", "Singularity"]
published: false
---

# Singularityã§PoetryãŒä½¿ã„ãŸã„
ã“ã‚Œã¾ã§Singualrityä¸Šã®Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã¯pipã§è¡Œã£ã¦ã„ã¾ã—ãŸï¼  
æœ€è¿‘ï¼Œä»¥ä¸‹ã®è¨˜äº‹ã‚’ãã£ã‹ã‘ã«Poetryã®å­˜åœ¨ã‚’çŸ¥ã‚Šï¼Œèª¿ã¹ã¦ã„ãã†ã¡ã«è™œã«ãªã‚Šã¾ã—ãŸï¼  
[Pythonç’°å¢ƒæ§‹ç¯‰[Pyenv+Poetry]ï½œç ”ç©¶ã®ãŸã‚ã®Pythoné–‹ç™ºç’°å¢ƒ](https://zenn.dev/zenizeni/books/a64578f98450c2/viewer/c6af80)  

ä»Šå¾Œï¼Œé–‹ç™ºã—ãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å…¬é–‹ã‚‚è¦‹æ®ãˆï¼Œç’°å¢ƒã®å†ç¾æ€§ã‚’æ‹…ä¿ã™ã‚‹ãŸã‚ã«ã‚‚Poetryã‚’å°å…¥ã—ãŸã„ã¨æ€ã„ã¾ã™ï¼  

ã¾ãŸå‰¯æ¬¡çš„ãªç”£ç‰©ã¨ã—ã¦ï¼ŒSingularityã§pipã‚’ä½¿ã†å ´åˆï¼Œæ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ã¯defãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†è¨˜è¿°ã—ã¦buildã—ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒï¼ŒPoetryã§ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã‹ã‚‰æ–°ãŸãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ ãŒå¯èƒ½ã§ã™ï¼ã‚‚ã¡ã‚ã‚“ï¼Œpyproject.tomlã«è¿½åŠ ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯è‡ªå‹•ã§è¨˜éŒ²ã•ã‚Œã‚‹ã®ã§ï¼Œå¾Œã®ç’°å¢ƒå†ç¾ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼  

# Definition File
å…ˆç¨‹ã®è¨˜äº‹ã«å¾“ã„ï¼ŒSingularityã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹Definition Fileã‚’ä»¥ä¸‹ã®é€šã‚Šè¨˜è¿°ã—ã¾ã—ãŸï¼  
```def:pyenvpoetry.def
Bootstrap: docker
From: nvidia/cuda:11.3.1-cudnn8-devel-ubuntu20.04

%environment
	export TZ=Asia/Tokyo
	export CUDA_PATH=/usr/local/cuda
	export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

	export PYENV_ROOT="/opt/pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"

	export POETRY_HOME=/opt/poetry
    export PATH=$POETRY_HOME/bin:$PATH

    export PYTHON_VERSION=3.11

%post
    perl -p -i.bak -e 's%(deb(?:-src|)\s+)https?://(?!archive\.canonical\.com|security\.ubuntu\.com)[^\s]+%$1http://ftp.riken.jp/Linux/ubuntu/%' /etc/apt/sources.list

	export DEBIAN_FRONTEND=noninteractive
	export TZ=Asia/Tokyo

	export PYENV_ROOT="/opt/pyenv"
	export PATH="$PYENV_ROOT/bin:$PATH"
	export PYTHON_VERSION=3.11
	export POETRY_ROOT="/opt/poetry"

	apt-get -y update
	apt-get -y dist-upgrade
    apt-get -y install \
		build-essential \
        curl \
        git \
        libbz2-dev \
        libffi-dev \
        libreadline-dev \
        libsqlite3-dev \
        libssl-dev \
        liblzma-dev \
        llvm \
        make \
        tk-dev \
        wget \
        xz-utils \
        zlib1g-dev

	# Install pyenv
    git clone https://github.com/pyenv/pyenv.git $PYENV_ROOT

	
	eval "$(pyenv init --path)"

	pyenv install $PYTHON_VERSION
	pyenv local $PYTHON_VERSION

	# Install poetry
	curl -sSL https://install.python-poetry.org | POETRY_HOME=$POETRY_ROOT python -

%labels
    Author msn
    Version v1.0.0
```
ä»Šå¾Œï¼ŒGPUã®æ´»ç”¨(PyTorchã®å°å…¥)ã‚’è¦–é‡ã«å…¥ã‚Œã¦ã„ã‚‹ãŸã‚ï¼Œãƒ™ãƒ¼ã‚¹ã«Dockerã§é…å¸ƒã•ã‚Œã¦ã„ã‚‹cudaã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒï¼Œã‚·ãƒ³ãƒ—ãƒ«ãªUbuntuç’°å¢ƒã§ã‚‚å•é¡Œãªã„ã¨æ€ã„ã¾ã™ï¼  

ã„ãã¤ã‹å†—é•·ãªéƒ¨åˆ†ï¼Œä¾‹ãˆã°apt-getã®å†…å®¹ãŒé©åˆ‡ã‹ã©ã†ã‹ãŒã‚ã‚Šã¾ã™ãŒï¼Œä»Šå¾Œèª¿æŸ»ã—ã¤ã¤æ”¹å–„ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ï¼  

æ³¨æ„ç‚¹ã¨ã—ã¦ï¼ŒBuildæ™‚ã«`%post`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯`/root`ã¨ãªã‚Šï¼Œå„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã«å½±éŸ¿ã—ã¾ã™ï¼  
ãã“ã§ï¼Œä»Šå›ã¯`/opt`ä»¥ä¸‹ã«æ˜ç¤ºçš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ï¼ã¾ãŸï¼Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã¸ã®ãƒ‘ã‚¹é–‹é€šã‚’`%environment`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¡Œã„ï¼Œshellå®Ÿè¡Œæ™‚ã«åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ï¼

# æ¤œè¨¼
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§Buildã—ã¾ã—ãŸï¼  
ç§ã®ç’°å¢ƒã§ã¯ï¼Œ`--fakeroot`æ¨©é™ã®ã¿ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã§Buildã—ã¦ã„ã¾ã™ï¼  

```sh:build
singularity build --fakeroot pyenvpoetry.sif pyenvpoetry.def
```

Buildå®Œäº†å¾Œã«ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å…¥ã‚Šï¼Œãƒ‘ã‚¹ã®é–‹é€šã¨ï¼ŒPython, Poetryã®å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã—ãŸï¼  
```sh:check
which pyenv
# /opt/pyenv/bin/pyenv

which poetry
# /opt/poetry/bin/poetry
```